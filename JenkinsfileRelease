pipeline {
    agent {
        node {
            label 'openshift4-prg-heavy'
        }
    }

    tools {
        maven 'Maven 3.6.3'
        jdk 'JDK11'
    }

    options {
        disableConcurrentBuilds()
        timestamps()
        ansiColor('xterm')
    }

    parameters {
        string(description: 'The Project Version for the next development iteration which will be set in the pom.xml', name: 'DEVELOPMENT_VERSION', trim: true)
        booleanParam(defaultValue: false, description: 'Run the maven release plugin with dryRun set to true', name: 'DRY_RUN')
    }

    stages {
        stage('SCM Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Maven Release Prepare & Perform') {
            when {
                allOf {
                    expression { return params.DEVELOPMENT_VERSION != "" }
                }
            }
            steps {
                withCredentials([sshUserPrivateKey(credentialsId: 'github-deploy-key', keyFileVariable: 'SSH_PRIVATE_KEY')]) {
                    withEnv(["RELEASE_VERSION=${params.RELEASE_VERSION}", "DEVELOPMENT_VERSION=${params.DEVELOPMENT_VERSION}", "DRY_RUN=${params.DRY_RUN}"]) {
                        script{
                            sh '''
                                # export GIT_SSH_COMMAND='ssh -o StrictHostKeyChecking=accept-new -o IdentitiesOnly=yes -i $SSH_PRIVATE_KEY -F /dev/null'
                                echo ssh -i $SSH_PRIVATE_KEY -l git -o StrictHostKeyChecking=accept-new \\"\\$@\\" > ${WORKSPACE}/ssh_key
                                chmod +x ${WORKSPACE}/ssh_key
                                export GIT_SSH=${WORKSPACE}/ssh_key
                                git remote set-url origin git@git.dhl.com:NDCW-10025/discover.git
                                git config --add --local core.sshCommand 'ssh -o StrictHostKeyChecking=accept-new -o IdentitiesOnly=yes -i ${SSH_PRIVATE_KEY}\'
                                echo "Next development version: $DEVELOPMENT_VERSION"
                                echo "Dry run: $DRY_RUN"
                                # env
                                # ls -la
                                # git remote -v
                                git config --list
                                # git fetch --all
                                mvn \
                                    -ntp \
                                    -DdryRun=$DRY_RUN \
                                    -Pdhl-artifactory \
                                    -Dresume=false \
                                    -Dtag=v$RELEASE_VERSION \
                                    -DnewVersion="$DEVELOPMENT_VERSION" \
                                    versions:set
                                git add --all
                                git commit -m "[maven versions plugin] Set next development version to $DEVELOPMENT_VERSION"
                                git push origin feature/update-to-releaser-job
                            '''
                        }
                    }
                }
            }
        }
    }
}
