pipeline {
    agent {
        node {
            label 'fortify_agent'
        }
    }

    environment {
        ARTIFACTORY = credentials('srv_jenkins_creds')
    }

    tools {
        maven 'Maven 3.6.3'
        jdk 'JDK11'
    }

    options {
        disableConcurrentBuilds()
        timestamps()
        ansiColor('xterm')
    }

    stages {
        stage('SCM Checkout') {
            steps{
                checkout scm
            }
        }

        stage('Artifactory configuration') {
            steps {
                rtServer (
                        id: 'server',
                        url: 'https://artifactory.dhl.com',
                        bypassProxy: true,
                        timeout: 300,
                        username: ARTIFACTORY_USR,
                        password: ARTIFACTORY_PSW
                )

                rtMavenResolver(
                        id: 'artifactory-resolver',
                        serverId: 'server',
                        releaseRepo: 'maven-release',
                        snapshotRepo: 'maven-snapshot'
                )

                rtMavenDeployer(
                        id: 'artifactory-deployer',
                        serverId: 'server',
                        releaseRepo: 'maven-dhl-release-local',
                        snapshotRepo: 'maven-dhl-snapshot-local'
                )
            }
        }

        stage('Fortify RUN') {
            steps {
                rtMavenRun (
                        tool: 'Maven 3.6.3',
                        useWrapper: false,
                        pom: 'pom.xml',
                        goals: """
                            --no-transfer-progress
                            com.fortify.sca.plugins.maven:sca-maven-plugin:clean
                            com.fortify.sca.plugins.maven:sca-maven-plugin:translate
                            com.fortify.sca.plugins.maven:sca-maven-plugin:scan
                            -Dfortify.sca.source.version=17
                        """,
                        resolverId: 'artifactory-resolver',
                        deployerId: 'artifactory-deployer',
                )
            }
        }

        stage('Fortify ASG'){
            steps {
                script {
                    try {
                        sh '''
                            /home/ci/FortifyASG.sh 375582152
                        '''
                    } catch (err) {
                        unstable(message: "${STAGE_NAME} is unstable; underlying error was... ${err}")
                    }
                }
            }
        }

        stage('Archive artifacts'){
            steps {
                script {
                    archiveArtifacts artifacts: 'issue.txt,issue.csv', allowEmptyArchive: true
                }
            }
        }
    }
}
