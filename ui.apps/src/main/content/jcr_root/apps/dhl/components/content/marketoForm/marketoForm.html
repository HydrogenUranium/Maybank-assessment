<sly data-sly-use.accountactions="com.dhl.discover.core.models.AccountActions"
     data-sly-use.cmf="com.dhl.discover.core.models.ConfigurableMarketoForm"
     data-sly-use.analytics="com.dhl.discover.core.models.TrackableComponent"
     data-sly-set.isEmpty="${!cmf.marketoformid}"></sly>

<div class="cq-placeholder" data-sly-test="${wcmmode.edit && isEmpty}" data-emptytext="${component.title}"></div>

<div id="${properties.id}" class="ship-now-group" data-sly-test="${!isEmpty}">
    <div class="forms cmp-marketoForm"
         formId="${cmf.marketoformid @ context='attribute'}"
         munchkinId="${cmf.marketoid @ context='attribute'}"
         formHost="${cmf.getVisibleFormHost @ context='attribute'}"
         hiddenFormId="${cmf.marketohiddenformid @ context='attribute'}"
         action="${accountactions.getAssetprefix}${currentPage.path}.form.html"
         formstart="${accountactions.getAssetprefix}${currentNode.path}.form.html"
         enhancedConversionUrl="${accountactions.getAssetprefix}${currentPage.path}.enhanced-google-conversion.html"
         googleConversionActionId="${cmf.googleConversionActionId @ context='attribute'}"
         source="conf"
         data-sly-attribute.data-analytics="${analytics.json}"
         data-marketo-form>
      <div class="cmp-marketoForm__container">
        <h3 class="cmp-marketoForm__title" data-sly-test.formTitle="${properties.formTitle}">${formTitle}</h3>
        <div data-marketo-visible-form>
          <form id="mktoForm_${cmf.marketoformid}"></form>
          <script src="${cmf.getVisibleFormHost}/js/forms2/js/forms2.min.js"></script>
            <script>
                MktoForms2.whenReady(function(form) {
                    fetch('/libs/granite/csrf/token.json')
                        .then(function(response) {
                            return response.json();
                        })
                        .then(function(data) {
                            var csrfToken = data.token;
                            console.log("CSRF token from AEM:", csrfToken);
                            form.onSubmit(function() {
                                form.addHiddenFields({
                                    ':cq_csrf_token': csrfToken
                                });
                            });
                        });
                });
            </script>
        </div>
      </div>
    </div>
</div>
